# cpcluster_common

`cpcluster_common` provides shared data types used by the CPCluster master node and normal nodes. It defines the structures for authentication and the messages exchanged between peers.

## Provided Types

- `JoinInfo` – contains the authentication token and address information (IP and numerical port) published by the master in `join.json`.
- `NodeMessage` – enum describing messages exchanged over TCP:
  - `RequestConnection(String)` – ask the master to connect to another node.
  - `ConnectionInfo(String, u16)` – master response giving target IP and port.
  - `GetConnectedNodes` and `ConnectedNodes(Vec<String>)` – request and response for the list of nodes currently in the cluster.
  - `SubmitTask { id, task }` – queue a new task on the master node.
  - `GetTaskResult(id)` – fetch the result of a previously submitted task.
  - `Disconnect` – tells the master a node is leaving.
  - `Heartbeat` – periodic keep-alive message sent by the nodes.
  - `AssignTask { id, task }` – instructs a peer to execute a `Task`.
  - `TaskResult { id, result }` – result of a task execution.
  - `TaskAccepted(id)` – acknowledgement that a task was queued.
  - `DirectMessage(String)` – simple string message between peers.

- `Task` – represents work sent between nodes:
  - `Compute { expression }` – evaluate a mathematical expression. The
    expression uses `Cow<'static, str>` so it can borrow a string slice or own
    the data.
  - `HttpRequest { url }` – perform a HTTP GET request.
  - `Tcp { addr, data }` – send bytes over a TCP connection.
  - `Udp { addr, data }` – send bytes over a UDP socket.
  - `ComplexMath { expression }` – evaluate a complex mathematical expression.
  - `StoreData { key, data }` – keep arbitrary bytes in memory under a key.
  - `RetrieveData { key }` – fetch bytes previously stored via `StoreData`.
  - `DiskWrite { path, data }` – write data to a file on disk.
  - `DiskRead { path }` – read data from a file.

- `TaskResult` – returned from task execution:
  - `Number(f64)` – result of a computation.
  - `Response(String)` – body of an HTTP request.
  - `Bytes(Vec<u8>)` – raw bytes from network or disk operations.
  - `Stored` – confirmation that data was kept in memory.
  - `Written` – confirmation that data was written to disk.
  - `Error(String)` – task failed with this error.

These types are `serde` serializable and are used by both the `cpcluster_masternode` and `cpcluster_node` crates.

## Configuration

`Config` offers runtime configuration such as port ranges, failover timeout and the list of master nodes. A default configuration is returned when the specified file is missing. The master and node binaries look for `config.json` unless a different path is provided on the command line.

Important fields include:

- **`role`** – `Worker` (default), `Disk` or `Internet`.
- **`storage_dir`** – directory for on-disk tasks or shared RAM-disk storage.
- **`internet_ports`** – ports bound by Internet nodes for external services.

`join.json` contains the authentication token generated by the master. Both binaries read it from the current directory by default. Set `CPCLUSTER_JOIN` to use a custom path or `CPCLUSTER_TOKEN` to supply the token via an environment variable.

## Helper Functions

- `is_local_ip(&str)` – returns `true` if the provided IP address is part of a private
  network. This allows the nodes to decide whether to enable TLS.
